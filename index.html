<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<style type="text/css">
		
		</style>

	<link href="css/bootstrap/bootstrap.css" rel="stylesheet" />
	<link href="css/style.css" rel="stylesheet" type="text/css"/>
<title>Montili Avis</title>
</head>

<body class="body container">
	
	<header class="header row">
		<div class="div-logo col-lg-4">
			<img src="img/logo_montiliAvis.png" alt="logo montili avis"/> 
		</div>
		<div class="col-header col-lg-2">
			
		</div>
		<div id="search" class="search col-lg-6">
			<div class="row">
				<div  class="col-lg-12">
					<h4>Recherche par filtres</h4>
				</div>
			</div>
			
			<form class="row">
				
				<input id="starMin" class="col-lg-3" type="number" placeholder="Entrez une valeur ici" min="0" max="5"/>
				
				<button type="button" class="search">Filtre moyenne d'étoiles</button>
			</form>
		</div>
	</header>
	
	<main class="row">
		<div class="main-col-1 col-lg-1"></div>
		<div class="col-lg-5">
			<div class="ban-ville col-lg-12" id="ban-ville">
				<img src="img/ban-ville.png" alt="banière montili avis"/>
			</div>
			<div class="col-lg-12" id="map"></div>
			<div class="legend col-lg-12">
				<div class="legend-elem">
					<span>Ville :</span><img class="img-legend" src="img/icons/panneau-ville-montelimar.png" alt="panneau de la ville de montélimar"/>
					<span>Votre position :</span><img class="img-legend" src="img/icons/vous-etes-ici.png" alt="Indique votre position"/>
					<span>Restaurant Google Places :</span><img class="img-legend" src="img/icons/restaurant.png" alt="Logo des retaurants trouver dans google place"/>
					<span>Restaurant Google Places Focus :</span><img class="img-legend-zoom" src="img/icons/restaurant-zoom.png" alt="Logo des retaurants focus trouver dans google place "/>
				</div>
			</div>
		</div>
		<div class="list col-lg-5" id="list">
				<h3>Liste restaurant</h3>
		</div>

		
		<div class="main-col-1 col-lg-1"></div>
	</main>
	
	<footer class="row">
		<p>Site d'avis restaurant p7 openclassroom</p>
	</footer>
	<script src="js/jquery.js" type="text/javascript"></script>
	<script src="js/restaurants.js" type="text/javascript"></script>
	<script src="https://maps.google.com/maps/api/js?libraries=places&key=AIzaSyByrNSyEIF-ix_iIq-ogoJCGqSIzLX-qJY" type="text/javascript"></script>
		
	</script>
	<script type="text/javascript">
	
	
	let map, infoWindow, latitude, longitude;
	let restaurants= [], restaurantsPlaces = [], restaurantsPlacesGetDetail = [], markerRestaurantAll = [], markerRestaurantZoom = [];
	let starMin = 0;
	let montelimar = {lat: 44.557939, lng: 4.750318};
	const POS = {};

	function initMap() {
		// Créer l'objet "map" et l'insèrer dans l'élément HTML qui a l'ID "map"
		map = new google.maps.Map(document.getElementById("map"), {
			// Nous plaçons le centre de la carte avec les coordonnées ci-dessus-
			center: new google.maps.LatLng(montelimar),
			// Nous définissons le zoom par défaut
			zoom: 17, 
			// Nous définissons le type de carte (ici carte routière)
			mapTypeId: google.maps.MapTypeId.ROADMAP, 
			// Nous activons les options de contrôle de la carte (plan, satellite...)
			mapTypeControl:  true,
			// Nous désactivons la roulette de souris
			scrollwheel: false, 
			mapTypeControlOptions: {
				// Cette option sert à définir comment les options se placent
				style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR 
			},
			// Activation des options de navigation dans la carte (zoom...)
			navigationControl: true, 
			navigationControlOptions: {
				// Comment ces options doivent-elles s'afficher
				style: google.maps.NavigationControlStyle.ZOOM_PAN 
			},
			styles : [
				{
					"featureType": "all",
                	"elementType": "labels.icon",
                	"stylers": [
						{
							"visibility": "off"
						}
                	]
				},
			]
		});

		new google.maps.Marker({
				position: montelimar,
				map,
				icon: 'img/icons/panneau-ville-montelimar.png'
		});

		infoWindow = new google.maps.InfoWindow();
		
		if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(position) => {
						POS.lat = position.coords.latitude,
						POS.lng = position.coords.longitude;
						
						let markerYourPos = new google.maps.Marker({
							position: POS,
							map: map,
							icon: 'img/icons/vous-etes-ici.png'
						});

						map.setCenter(POS);
						nearbySearch(POS);
						
					}
				);
		} else {
				// Browser doesn't support Geolocation
				handleLocationError(false, infoWindow, map.getCenter());
		}
		
	function nearbySearch(POS){
		let placesServiceRequest = {
			location: POS,
			radius: '250',
			type: ['restaurant']
		};

		let service = new google.maps.places.PlacesService(map);
		service.nearbySearch(placesServiceRequest, callbackNearbySearch);
	}
	
	function getDetailRecursive(array) {

		if (!array[0]) {
			console.log('fin appel recursif');	
			return 0
		}
		let element = array.shift()
	
		let getDetailsRequest = {
			placeId: element.placeId,
			fields: ['place_id', 'formatted_phone_number', 'opening_hours', 'website', 'price_level', 'reviews']
		}
		let serviceII = new google.maps.places.PlacesService(map);
		serviceII.getDetails(getDetailsRequest, (place, status) => {
		
			if (status === google.maps.places.PlacesServiceStatus.OK) {
				// TODO: ajouter le resto au DOM

				// Appel récursif
				window.setTimeout(() => {
					
				
					getDetailRecursive(array)
					
					let newRestaurant = new Restaurants (
						element.idRestaurant,
						element.placeId,
						element.name,
						element.address,
						element.lat,
						element.lng,
						element.userRatingsTotal,
						element.rating,
						place.formatted_phone_number,
			            place.reviews,
						place.opening_hours,
						place.price_level
					)
					const searchBtn = document.querySelector('#search');
					// Tu récupère le bouton de recherche.
					const starMin = document.querySelector('#starMin');
					Restaurants.displayRestaurants(newRestaurant, starMin.value || 0)
			
					Restaurants.addListenerFormAndComment();
					// Tu récupère le champs de notation minimum.
					searchBtn.addEventListener('click', function handler(event) {
						deleteMarker();
						Restaurants.clearList();
					
						Restaurants.displayRestaurants(newRestaurant, starMin.value || 0)
						// Ici event listeners
						Restaurants.addListenerFormAndComment();
					})
				}, 300)
				
			} else {
				console.log(status);
			}
			
		})
	}
	
	function callbackNearbySearch(placesServiceRequest, status) {
		if (status == google.maps.places.PlacesServiceStatus.OK) {
			for (var i = 0; i < placesServiceRequest.length; i++) {
				idRestaurantGooglePlace = i;
				arrayRestaurantsPlaces(placesServiceRequest[i], idRestaurantGooglePlace)
			}
		}
		let array = restaurantsPlaces;
		
		getDetailRecursive(array)
		
	
		
	/*
			})*/
	}
	
	function arrayRestaurantsPlaces(placesServiceRequest, idRestaurantGooglePlace){

		let restaurantPlace = {
			'idRestaurant' : idRestaurantGooglePlace,
			'placeId' : placesServiceRequest.place_id,
			'name' : placesServiceRequest.name,
			'address' : placesServiceRequest.vicinity,
			'lat': placesServiceRequest.geometry.location.lat(),
			'lng': placesServiceRequest.geometry.location.lng(),
			'userRatingsTotal' : placesServiceRequest.user_ratings_total,
			'rating' : placesServiceRequest.rating

		}
		restaurantsPlaces.push(restaurantPlace)
	}
	

	map.addListener("click", (e) => {
		placeMarkerNewRestaurant(e.latLng, map);
		Restaurants.addNewRestaurant(e.latLng.lat(), e.latLng.lng());
	});
		
}

	function addMarker(lat, lng){
		let marker = new google.maps.Marker({
			position: {lat, lng},
			map,
			icon: 'img/icons/restaurant.png'
		});
		markerRestaurantAll.push(marker);
	}
	
	function addMarkerZoom(lat, lng){
		let marker = new google.maps.Marker({
			position: {lat, lng},
			map,
			icon: 'img/icons/restaurant-zoom.png'
		});
		markerRestaurantZoom.push(marker);
		map.setCenter({lat, lng});
	}
	
	function placeMarkerNewRestaurant(latLng, map){
		let marker = new google.maps.Marker({
			position: latLng,
			map: map,
			icon: 'img/icons/restaurant-zoom.png'
		});
		markerRestaurantZoom.push(marker);
		map.panTo(latLng);
	}
	
	function deleteMarker(){
		for(i= 0; i < markerRestaurantAll.length; i++){
			markerRestaurantAll[i].setMap(null);
		}
		markerRestaurantAll = [];
	}
	function deleteMarkerZoom(){
		for(i=0; i < markerRestaurantZoom.length; i++){
			markerRestaurantZoom[i].setMap(null);
		}
		markerRestaurantZoom = [];
	}

	function handleLocationError(browserHasGeolocation, infoWindow, POS) {
  		infoWindow.setPosition(POS);
  		infoWindow.setContent(
			browserHasGeolocation
				? "Error: The Geolocation service failed."
				: "Error: Your browser doesn't support geolocation."
  		);
  		infoWindow.open(map);
	}

	window.onload = function(){
		// Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
		initMap();
	};
	</script>
</body>
</html>
